# Story 6.1: Form Draft Auto-Save & Recovery System

## Status
Draft

## Story
**As a** user filling out a travel request form,
**I want** my progress to be automatically saved to the cloud with multiple concurrent drafts,
**So that** I can safely close my browser, continue later, or work on multiple trips simultaneously without losing data.

## Acceptance Criteria

1. **Enhanced form_drafts Table:**
   - Modify existing `form_drafts` table with new columns:
     - `draft_title` (auto-generated from destination)
     - `trip_destination`, `trip_start_date`, `trip_end_date` (quick identification)
     - `completion_percentage` (0-100)
     - `expires_at` (created_at + 15 days)
     - `notified_at` (when 7-day warning sent)
   - Keep existing: `id`, `user_id`, `form_data` (JSONB), `current_page`, `created_at`, `updated_at`
   - Rename `updated_at` to `last_saved_at` for clarity
   - Remove `UNIQUE(user_id)` constraint to allow multiple drafts
   - Add indexes on `user_id`, `expires_at`
   - Update RLS policies for user-only access

2. **Auto-Save Implementation:**
   - Create API endpoint: `POST /api/form-drafts` (create/update draft)
   - Create API endpoint: `GET /api/form-drafts` (list user's drafts)
   - Create API endpoint: `GET /api/form-drafts/[id]` (get specific draft)
   - Create API endpoint: `DELETE /api/form-drafts/[id]` (delete draft)
   - Create hook: `useFormDraft()` with methods:
     - `saveDraft()` - Manual and auto-triggered save
     - `loadDraft(id)` - Load specific draft
     - `deleteDraft(id)` - Remove draft
   - Integrate auto-save triggers:
     - On step completion (after validation passes)
     - Every 60 seconds of inactivity (debounced)
     - Manual "Salvar Rascunho" button on all pages

3. **Draft Management UI:**
   - Create component: `<FormDraftCard />` with:
     - Draft title (e.g., "Viagem para SÃ£o Paulo")
     - Destination and dates preview
     - Progress bar and percentage (e.g., "75% - Step 6 of 8")
     - Last edited timestamp (e.g., "Editado hÃ¡ 2 horas")
     - Expiration warning if < 7 days (âš ï¸ badge)
     - Actions: [Continuar] [Excluir]
   - Modify `/app/my-requests/page.tsx`:
     - Add "RASCUNHOS" section above "SOLICITAÃ‡Ã•ES ENVIADAS"
     - Fetch and display user's drafts
     - Handle click â†’ navigate to `/form?draftId={id}`
   - Add visual indicator in form header:
     - "âœ“ Salvo automaticamente Ã s 18:30" (when saved)
     - "Salvando..." (during save operation)

4. **Recovery Dialog:**
   - Create component: `<DraftRecoveryDialog />`
   - On form mount, check for existing drafts
   - If drafts exist and no `draftId` in URL:
     - Show dialog: "VocÃª tem rascunhos salvos. Continuar de onde parou?"
     - List up to 3 most recent drafts with preview
     - Options: "Continuar Rascunho" | "ComeÃ§ar do Zero"
   - If `draftId` in URL:
     - Load specified draft automatically
     - Navigate to `current_page`
     - Populate Zustand store with `form_data`

5. **TTL and Cleanup:**
   - Add server-side function: `notifyExpiringDrafts()`
     - Runs daily (cron or edge function)
     - Find drafts where `expires_at - 7 days < now` AND `notified_at IS NULL`
     - Set `notified_at = now()`
   - Add server-side function: `cleanupExpiredDrafts()`
     - Runs daily
     - Delete drafts where `expires_at < now()`
   - On draft edit/save:
     - Reset `expires_at = now() + 15 days`
     - Keep active drafts alive
   - Display warning in draft card if expiring soon

6. **Exit Confirmation:**
   - Add `beforeunload` handler in form pages
   - Check if Zustand state !== last saved cloud state
   - If unsaved changes, show browser confirmation:
     - "VocÃª tem alteraÃ§Ãµes nÃ£o salvas. Deseja salvar antes de sair?"
   - Optional: Custom modal with "Salvar e Sair" | "Sair sem Salvar" | "Cancelar"

7. **Testing and Validation:**
   - Verify multiple drafts can exist per user
   - Verify drafts sync across devices (save on desktop, load on mobile)
   - Verify TTL notifications work (7-day warning)
   - Verify auto-delete works (15-day cleanup)
   - Verify "Salvo automaticamente" indicator updates correctly
   - Test recovery dialog only shows when drafts exist
   - Test draft deletion removes from DB and UI

## Tasks / Subtasks

### Task 1: Database Schema Enhancement (AC: 1)
- [ ] Create migration file: `20251019_enhance_form_drafts_table.sql`
- [ ] Remove `UNIQUE(user_id)` constraint from `form_drafts` table
- [ ] Add new columns to `form_drafts`:
  - [ ] `draft_title TEXT` - Auto-generated title from destination
  - [ ] `trip_destination TEXT` - Extracted from form_data for quick lookup
  - [ ] `trip_start_date DATE` - Extracted from form_data
  - [ ] `trip_end_date DATE` - Extracted from form_data
  - [ ] `completion_percentage INTEGER DEFAULT 0` - 0-100 progress
  - [ ] `expires_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '15 days')`
  - [ ] `notified_at TIMESTAMPTZ` - When 7-day warning sent
- [ ] Rename column: `updated_at` â†’ `last_saved_at`
- [ ] Add indexes:
  - [ ] `CREATE INDEX idx_form_drafts_user_id ON form_drafts(user_id);`
  - [ ] `CREATE INDEX idx_form_drafts_expires_at ON form_drafts(expires_at) WHERE expires_at > NOW();`
- [ ] Verify RLS policy exists: `CREATE POLICY "Users can manage own drafts" ON form_drafts FOR ALL USING (auth.uid() = user_id);`
- [ ] Apply migration using Supabase MCP `apply_migration` tool
- [ ] Verify migration applied successfully with `execute_sql`

### Task 2: API Endpoints Implementation (AC: 2)
- [ ] Create `/app/api/form-drafts/route.ts`:
  - [ ] `GET` handler - List all user's drafts (order by `last_saved_at DESC`)
  - [ ] `POST` handler - Create new draft or update existing:
    - [ ] Extract `trip_destination`, `trip_start_date`, `trip_end_date` from `form_data`
    - [ ] Generate `draft_title`: "Viagem para {destination}" or "Rascunho {number}" if no destination
    - [ ] Calculate `completion_percentage` based on `current_page` (page/8 * 100)
    - [ ] Set `expires_at = NOW() + 15 days` (reset on every save)
    - [ ] Return draft ID and metadata
- [ ] Create `/app/api/form-drafts/[id]/route.ts`:
  - [ ] `GET` handler - Fetch specific draft by ID (verify user ownership via RLS)
  - [ ] `DELETE` handler - Delete specific draft (verify user ownership via RLS)
- [ ] Add Zod validation schemas for draft creation/update
- [ ] Add error handling for all endpoints (401, 404, 500)
- [ ] Test all endpoints with Postman or similar tool

### Task 3: useFormDraft Hook (AC: 2)
- [ ] Create `/hooks/useFormDraft.ts` with TypeScript interface:
  ```typescript
  interface UseFormDraftReturn {
    drafts: FormDraft[];
    loading: boolean;
    saving: boolean;
    saveDraft: (formData: any, currentPage: number) => Promise<string | null>;
    loadDraft: (draftId: string) => Promise<FormDraft | null>;
    deleteDraft: (draftId: string) => Promise<boolean>;
    refreshDrafts: () => Promise<void>;
  }
  ```
- [ ] Implement `saveDraft()`:
  - [ ] Call `POST /api/form-drafts` with form data
  - [ ] Handle success/error with toast notifications
  - [ ] Return draft ID on success
- [ ] Implement `loadDraft()`:
  - [ ] Call `GET /api/form-drafts/[id]`
  - [ ] Return full draft object
- [ ] Implement `deleteDraft()`:
  - [ ] Call `DELETE /api/form-drafts/[id]`
  - [ ] Refresh draft list on success
- [ ] Implement `refreshDrafts()`:
  - [ ] Call `GET /api/form-drafts` to reload list
- [ ] Add React Query integration for caching and auto-refresh

### Task 4: Auto-Save Integration in Form Store (AC: 2)
- [ ] Modify `/stores/form-store.ts`:
  - [ ] Add `currentDraftId: string | null` to state
  - [ ] Add `lastCloudSave: number | null` to state (timestamp)
  - [ ] Add action `setCurrentDraftId(id: string | null)`
  - [ ] Add action `setLastCloudSave(timestamp: number)`
  - [ ] Add method `hasUnsavedChanges(): boolean`:
    - [ ] Compare `lastAutoSave` vs `lastCloudSave`
    - [ ] Return true if local changes exist
- [ ] Create debounced auto-save utility in `/lib/auto-save.ts`:
  - [ ] Use `lodash.debounce` or custom implementation
  - [ ] 60-second debounce delay
  - [ ] Only trigger if `hasUnsavedChanges() === true`
- [ ] Integrate auto-save in form pages:
  - [ ] Add `useEffect` hook for 60-second debounced save
  - [ ] Trigger save on step completion (after validation)
  - [ ] Add manual "Salvar Rascunho" button to all form pages

### Task 5: Draft Card Component (AC: 3)
- [ ] Create `/components/form/form-draft-card.tsx`:
  - [ ] Props: `draft: FormDraft`, `onContinue: (id) => void`, `onDelete: (id) => void`
  - [ ] Display draft title prominently
  - [ ] Show destination and date range if available
  - [ ] Progress bar with percentage (e.g., "75% completo - Step 6 of 8")
  - [ ] Format last edited time: `formatDistanceToNow()` from `date-fns`
  - [ ] Conditional expiration warning badge:
    - [ ] If `expires_at - now < 7 days`: Show âš ï¸ "Expira em X dias"
  - [ ] Action buttons:
    - [ ] "Continuar" (primary) - Calls `onContinue(draft.id)`
    - [ ] "Excluir" (destructive) - Shows confirmation, then calls `onDelete(draft.id)`
- [ ] Style with shadcn/ui Card, Badge, Button components
- [ ] Add hover effects and cursor-pointer for interactivity
- [ ] Test card with different draft states (new, midway, expiring)

### Task 6: My Requests Page Enhancement (AC: 3)
- [ ] Modify `/app/my-requests/page.tsx`:
  - [ ] Import `useFormDraft` hook
  - [ ] Call `const { drafts, deleteDraft, refreshDrafts } = useFormDraft()`
  - [ ] Add "RASCUNHOS" section above "SOLICITAÃ‡Ã•ES ENVIADAS":
    ```tsx
    {drafts.length > 0 && (
      <div className="mb-8">
        <h3 className="text-2xl font-bold text-white mb-4">
          ðŸŸ  RASCUNHOS ({drafts.length})
        </h3>
        <div className="grid gap-4">
          {drafts.map(draft => (
            <FormDraftCard
              key={draft.id}
              draft={draft}
              onContinue={(id) => router.push(`/form?draftId=${id}`)}
              onDelete={async (id) => {
                await deleteDraft(id);
                refreshDrafts();
              }}
            />
          ))}
        </div>
      </div>
    )}
    ```
  - [ ] Ensure drafts are sorted by `last_saved_at DESC`
  - [ ] Add loading state while fetching drafts
  - [ ] Test navigation to form with `draftId` parameter

### Task 7: Save Indicator Component (AC: 3)
- [ ] Create `/components/form/save-indicator.tsx`:
  - [ ] Accept props: `saving: boolean`, `lastSaved: Date | null`
  - [ ] Display states:
    - [ ] `saving === true`: "Salvando..." with spinner
    - [ ] `saving === false && lastSaved`: "âœ“ Salvo automaticamente Ã s HH:MM"
    - [ ] `saving === false && !lastSaved`: No indicator
  - [ ] Format time with `format(lastSaved, 'HH:mm', { locale: ptBR })`
  - [ ] Style with subtle text color (text-slate-400)
  - [ ] Position in form header or footer
- [ ] Integrate in form layout component
- [ ] Test different save states

### Task 8: Draft Recovery Dialog (AC: 4)
- [ ] Create `/components/form/draft-recovery-dialog.tsx`:
  - [ ] Props: `drafts: FormDraft[]`, `onSelect: (id) => void`, `onNew: () => void`
  - [ ] Use shadcn/ui Dialog component
  - [ ] Dialog content:
    - [ ] Title: "VocÃª tem rascunhos salvos"
    - [ ] Subtitle: "Continuar de onde parou?"
    - [ ] List up to 3 most recent drafts with mini-preview:
      - [ ] Draft title
      - [ ] Progress percentage
      - [ ] Last edited time
    - [ ] Buttons:
      - [ ] "Continuar Rascunho" for each draft (calls `onSelect(draft.id)`)
      - [ ] "ComeÃ§ar do Zero" (calls `onNew()`)
  - [ ] Auto-open when drafts exist and no `draftId` in URL
  - [ ] Close dialog after selection
- [ ] Integrate in `/app/form/page.tsx`:
  - [ ] Check for `draftId` in URL params
  - [ ] If no `draftId` and `drafts.length > 0`: Show dialog
  - [ ] If `draftId` exists: Auto-load that draft

### Task 9: Draft Loading Logic (AC: 4)
- [ ] Modify `/app/form/page.tsx`:
  - [ ] Add `useSearchParams()` to read `draftId` from URL
  - [ ] Add `useFormDraft()` hook
  - [ ] On mount, check for `draftId`:
    ```typescript
    useEffect(() => {
      const draftId = searchParams.get('draftId');
      if (draftId) {
        loadDraft(draftId).then(draft => {
          if (draft) {
            updateFormData(draft.form_data);
            setCurrentPage(draft.current_page);
            setCurrentDraftId(draftId);
            toast.success('Rascunho carregado com sucesso!');
          }
        });
      }
    }, [searchParams]);
    ```
  - [ ] Handle loading errors (draft not found, unauthorized)
  - [ ] Navigate to correct page after loading
- [ ] Test draft loading from URL
- [ ] Test draft loading from recovery dialog

### Task 10: TTL Management Functions (AC: 5)
- [ ] Create `/app/api/cron/notify-expiring-drafts/route.ts`:
  - [ ] Protected endpoint (verify cron secret or Supabase service key)
  - [ ] Query for drafts: `expires_at - INTERVAL '7 days' < NOW() AND notified_at IS NULL`
  - [ ] For each draft:
    - [ ] Update `notified_at = NOW()`
    - [ ] (Future: Send email notification)
  - [ ] Return count of notifications sent
- [ ] Create `/app/api/cron/cleanup-expired-drafts/route.ts`:
  - [ ] Protected endpoint (verify cron secret or Supabase service key)
  - [ ] Delete drafts: `DELETE FROM form_drafts WHERE expires_at < NOW()`
  - [ ] Return count of drafts deleted
- [ ] Document cron setup in README:
  - [ ] Supabase Edge Functions cron schedule
  - [ ] Or external cron service (e.g., cron-job.org)
- [ ] Test cron endpoints manually with Postman

### Task 11: Exit Confirmation Handler (AC: 6)
- [ ] Create `/lib/use-before-unload.ts` custom hook:
  ```typescript
  export function useBeforeUnload(hasUnsavedChanges: boolean) {
    useEffect(() => {
      const handleBeforeUnload = (e: BeforeUnloadEvent) => {
        if (hasUnsavedChanges) {
          e.preventDefault();
          e.returnValue = 'VocÃª tem alteraÃ§Ãµes nÃ£o salvas. Deseja salvar antes de sair?';
        }
      };
      window.addEventListener('beforeunload', handleBeforeUnload);
      return () => window.removeEventListener('beforeunload', handleBeforeUnload);
    }, [hasUnsavedChanges]);
  }
  ```
- [ ] Integrate in form pages:
  - [ ] Call `useBeforeUnload(hasUnsavedChanges())` in each form page
  - [ ] `hasUnsavedChanges()` from Zustand store
- [ ] Test browser close/refresh triggers confirmation
- [ ] (Optional) Create custom modal with "Salvar e Sair" | "Sair sem Salvar" | "Cancelar"

### Task 12: Testing and Validation (AC: 7)
- [ ] Manual testing scenarios:
  - [ ] Create 3 different drafts for different destinations
  - [ ] Verify all 3 appear in "My Requests" page
  - [ ] Continue each draft and verify correct data loaded
  - [ ] Delete one draft and verify removed from UI and DB
  - [ ] Close browser mid-form and verify auto-save preserved data
  - [ ] Wait 60 seconds of inactivity and verify auto-save triggered
  - [ ] Test cross-device (save on desktop, load on mobile browser)
  - [ ] Simulate 7-day passage (manual DB update) and verify notification
  - [ ] Simulate 15-day passage (manual DB update) and verify deletion
  - [ ] Test exit confirmation when leaving with unsaved changes
  - [ ] Test recovery dialog shows only when drafts exist
  - [ ] Test "Salvo automaticamente" indicator updates correctly
- [ ] Write unit tests for key functions:
  - [ ] `calculateCompletionPercentage()`
  - [ ] `generateDraftTitle()`
  - [ ] `hasUnsavedChanges()`
- [ ] (Optional) Write integration tests for API endpoints

## Dev Notes

### Database Schema Context
[Source: architecture/database-schema.md#form-drafts-table]

**Current `form_drafts` Table:**
```sql
CREATE TABLE public.form_drafts (
    id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    form_data JSONB NOT NULL,
    current_page INTEGER DEFAULT 1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id) -- âš ï¸ MUST BE REMOVED to allow multiple drafts
);
```

**Required Changes:**
1. **Remove constraint**: `DROP CONSTRAINT form_drafts_user_id_key;` (UNIQUE constraint)
2. **Add columns**: `draft_title`, `trip_destination`, `trip_start_date`, `trip_end_date`, `completion_percentage`, `expires_at`, `notified_at`
3. **Rename column**: `updated_at` â†’ `last_saved_at`
4. **Add indexes**: On `user_id`, `expires_at`

**RLS Policy (existing):**
```sql
CREATE POLICY "Users can manage own drafts" ON form_drafts
    FOR ALL USING (auth.uid() = user_id);
```
This policy is already correct and allows users full CRUD access to their own drafts only.

### Data Models
[Source: architecture/data-models.md#travelrequest]

**FormDraft TypeScript Interface:**
```typescript
interface FormDraft {
  id: string;
  user_id: string;
  draft_title: string;           // Auto-generated: "Viagem para SÃ£o Paulo"
  form_data: TravelRequestInput; // Complete form state from Zustand
  current_page: number;           // 1-8
  completion_percentage: number;  // 0-100

  // Quick identification fields (extracted from form_data)
  trip_destination: string | null;
  trip_start_date: string | null;  // ISO date string
  trip_end_date: string | null;    // ISO date string

  // Timestamps
  created_at: string;      // ISO timestamp
  last_saved_at: string;   // ISO timestamp
  expires_at: string;      // ISO timestamp (created_at + 15 days)
  notified_at: string | null; // ISO timestamp (when 7-day warning sent)
}
```

**form_data Structure:**
The `form_data` JSONB column contains the complete Zustand form state, matching the `TravelRequestInput` interface from `/stores/form-store.ts`. This includes all 56+ fields across 8 form pages.

### API Endpoints Specification
[Source: architecture/rest-api-spec.md#patterns]

**Endpoint Pattern:**
```
POST   /api/form-drafts          - Create or update draft
GET    /api/form-drafts          - List user's drafts
GET    /api/form-drafts/[id]     - Get specific draft
DELETE /api/form-drafts/[id]     - Delete draft
```

**Request/Response Format:**
```typescript
// POST /api/form-drafts
Request: {
  form_data: TravelRequestInput;
  current_page: number;
  draft_id?: string; // Optional: if updating existing draft
}

Response: {
  success: boolean;
  draft_id: string;
  message: string;
}

// GET /api/form-drafts
Response: {
  drafts: FormDraft[];
}

// DELETE /api/form-drafts/[id]
Response: {
  success: boolean;
  message: string;
}
```

**Authentication:**
All endpoints use Supabase `createClient()` from `/lib/supabase/server.ts` to verify authentication. RLS policies automatically filter results to user's own drafts.

### Component Architecture
[Source: architecture/frontend-architecture.md#component-organization]

**File Locations:**
- `/components/form/form-draft-card.tsx` - Draft card UI component
- `/components/form/draft-recovery-dialog.tsx` - Recovery dialog on form mount
- `/components/form/save-indicator.tsx` - Auto-save status indicator
- `/hooks/useFormDraft.ts` - Draft management hook
- `/lib/auto-save.ts` - Debounced auto-save utility
- `/lib/use-before-unload.ts` - Exit confirmation hook

**Component Pattern:**
Follow existing form component pattern from `passenger-data.tsx`:
- Use `'use client'` directive
- Import from `@/components/ui/*` for shadcn components
- Use Zustand `useFormStore()` for state access
- Use React Hook Form with Zod validation
- Portuguese labels and error messages

### State Management
[Source: architecture/frontend-architecture.md + existing form-store.ts]

**Zustand Store Extensions:**
Add to `/stores/form-store.ts`:
```typescript
interface FormState {
  // ... existing state ...

  // New draft-related state
  currentDraftId: string | null;
  lastCloudSave: number | null; // Timestamp of last Supabase save

  // New actions
  setCurrentDraftId: (id: string | null) => void;
  setLastCloudSave: (timestamp: number) => void;
  hasUnsavedChanges: () => boolean;
}
```

**localStorage Persistence:**
Zustand already persists to localStorage via `persist` middleware. This provides Layer 1 (immediate) save. Layer 2 (cloud) is the new Supabase auto-save.

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Test File Locations:**
- Unit tests: `/tests/unit/hooks/useFormDraft.test.ts`
- Component tests: `/tests/unit/components/form-draft-card.test.tsx`
- Integration tests: `/tests/integration/api/form-drafts.test.ts`

**Testing Framework:**
- Vitest for unit/component tests
- React Testing Library for component rendering
- MSW (Mock Service Worker) for API mocking
- Playwright for E2E testing (optional)

**Key Test Cases:**
1. Multiple drafts can coexist for same user
2. Draft auto-saves after 60 seconds
3. Draft loads correctly from URL parameter
4. Expiration warnings display correctly
5. Auto-delete removes expired drafts
6. Recovery dialog shows only when drafts exist
7. Exit confirmation triggers with unsaved changes

### Coding Standards
[Source: architecture/coding-standards.md]

**TypeScript:**
- Use strict type checking
- Define interfaces for all data structures
- No `any` types without explicit justification

**React:**
- Functional components only (no class components)
- Use hooks for state and side effects
- Memoize expensive computations with `useMemo`/`useCallback`

**API Routes:**
- Always validate user authentication first
- Use Zod schemas for request validation
- Return consistent error response format
- Log errors with context for debugging

**Naming Conventions:**
- Components: PascalCase (`FormDraftCard.tsx`)
- Hooks: camelCase with `use` prefix (`useFormDraft.ts`)
- Files: kebab-case for utilities (`auto-save.ts`)

### Previous Story Insights
[Source: Story 5.3 Dev Agent Record]

**Key Learnings:**
- Supabase MCP tools (`apply_migration`, `execute_sql`) are reliable for database operations
- Always verify migrations with `execute_sql` queries after applying
- Field name mismatches (camelCase vs snake_case) cause frequent errors - double-check mappings
- RLS policies must be explicitly enabled and tested
- Date formatting requires UTC-aware handling to avoid timezone issues

**Patterns to Follow:**
- Use `createClient()` from `/lib/supabase/server.ts` for API routes
- Use `createClient()` from `/lib/supabase/client.ts` for browser client (hooks)
- Always handle authentication errors (401) gracefully
- Use toast notifications (`sonner`) for user feedback

### Technical Constraints

**Performance:**
- Auto-save debounce: 60 seconds minimum to avoid excessive database writes
- Limit draft list to 10 most recent per user in UI (pagination optional)
- Index `expires_at` for efficient cron job queries

**Storage:**
- `form_data` JSONB can be large (~5-10 KB per draft)
- Assume max 10 active drafts per user (~100 KB total)
- TTL cleanup prevents unbounded growth

**Security:**
- All API endpoints verify authentication via Supabase
- RLS policies enforce user can only access own drafts
- Cron endpoints require secret token or service role key

**Browser Compatibility:**
- `beforeunload` event supported in all modern browsers
- localStorage available in all target browsers
- JSONB stringification/parsing handled by Supabase SDK

### Timezone Handling
[Source: Previous bugs with date formatting]

**Important:** All timestamps in database are `TIMESTAMPTZ` (UTC). When displaying to users:
1. Use `format()` from `date-fns` with `ptBR` locale
2. For relative time: `formatDistanceToNow(new Date(draft.last_saved_at), { locale: ptBR, addSuffix: true })`
3. For dates from form_data: Parse as local, not UTC (see `formatDateLocal()` helper)

## Testing

### Test File Locations
[Source: architecture/testing-strategy.md]

- Unit tests: `/apps/web/tests/unit/`
- Component tests: `/apps/web/tests/unit/components/`
- Integration tests: `/apps/web/tests/integration/`
- E2E tests: `/apps/web/tests/e2e/`

### Testing Standards
[Source: architecture/testing-strategy.md]

**Framework:** Vitest + React Testing Library

**Unit Test Pattern:**
```typescript
import { describe, it, expect, vi } from 'vitest';
import { renderHook, waitFor } from '@testing-library/react';
import { useFormDraft } from '@/hooks/useFormDraft';

describe('useFormDraft', () => {
  it('should save draft and return draft ID', async () => {
    const { result } = renderHook(() => useFormDraft());

    const draftId = await result.current.saveDraft({ /* form data */ }, 1);

    expect(draftId).toBeTruthy();
  });
});
```

**Component Test Pattern:**
```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { FormDraftCard } from '@/components/form/form-draft-card';

describe('FormDraftCard', () => {
  it('should display draft title and progress', () => {
    const draft = {
      id: '123',
      draft_title: 'Viagem para SÃ£o Paulo',
      completion_percentage: 75,
      current_page: 6,
      // ...other fields
    };

    render(<FormDraftCard draft={draft} onContinue={vi.fn()} onDelete={vi.fn()} />);

    expect(screen.getByText('Viagem para SÃ£o Paulo')).toBeInTheDocument();
    expect(screen.getByText('75% completo - Step 6 of 8')).toBeInTheDocument();
  });
});
```

**API Test Pattern:**
```typescript
import { describe, it, expect } from 'vitest';
import { POST } from '@/app/api/form-drafts/route';

describe('POST /api/form-drafts', () => {
  it('should create new draft', async () => {
    const request = new Request('http://localhost/api/form-drafts', {
      method: 'POST',
      body: JSON.stringify({
        form_data: { /* ... */ },
        current_page: 1
      })
    });

    const response = await POST(request);
    const data = await response.json();

    expect(response.status).toBe(200);
    expect(data.success).toBe(true);
    expect(data.draft_id).toBeTruthy();
  });
});
```

### Specific Testing Requirements for This Story

1. **Draft Lifecycle Testing:**
   - Create multiple drafts for same user
   - Update existing draft
   - Delete draft
   - Verify auto-delete after 15 days

2. **Auto-Save Testing:**
   - Verify debounce works (60s delay)
   - Verify save on step completion
   - Verify manual save button

3. **UI Testing:**
   - Draft card displays all information correctly
   - Recovery dialog shows on form mount
   - Save indicator updates in real-time
   - Expiration warning appears when < 7 days

4. **Edge Cases:**
   - Draft with no destination (title generation)
   - Draft with partial data (missing fields)
   - Concurrent saves from different devices
   - Network failure during save

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by development agent_

### Debug Log References
_To be populated by development agent_

### Completion Notes
_To be populated by development agent_

### File List
_To be populated by development agent_

## QA Results
_To be populated by QA agent_
