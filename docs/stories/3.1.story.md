# Story 3.1: File Upload Infrastructure

## Status
Done

## Story
**As a** developer,
**I want** to implement secure file upload handling,
**so that** users can attach required documents to their requests.

## Acceptance Criteria
1. File upload API endpoint at /api/upload accepting multipart form data
2. File validation for type (images: jpg, png; documents: pdf, doc, docx)
3. File size validation (max 10MB per file)
4. Files stored in public/uploads/ with unique naming (timestamp + original name)
5. Supabase Storage bucket configured for file storage (alternative to local)
6. Upload progress indicator showing percentage complete
7. Error handling for failed uploads with Portuguese error messages
8. Cleanup mechanism for orphaned files (uploaded but not submitted)

## Tasks / Subtasks
- [x] Create file upload API endpoint (AC: 1)
  - [x] Set up /api/upload route handler
  - [x] Configure multipart form data parsing
  - [x] Implement request validation
- [x] Implement file validation (AC: 2, 3)
  - [x] Create file type validator for images (jpg, png)
  - [x] Create file type validator for documents (pdf, doc, docx)
  - [x] Implement file size validation (10MB max)
  - [x] Add Portuguese error messages for validation failures
- [x] Set up file storage system (AC: 4, 5)
  - [x] Create public/uploads directory structure
  - [x] Implement unique file naming with timestamp
  - [x] Configure Supabase Storage bucket
  - [x] Create storage abstraction to support both local and Supabase
- [x] Implement upload progress tracking (AC: 6)
  - [x] Create progress event emitter
  - [x] Calculate and return upload percentage
  - [x] Handle progress updates for client
- [x] Add error handling and cleanup (AC: 7, 8)
  - [x] Create comprehensive error handling for upload failures
  - [x] Implement Portuguese error messages
  - [x] Create orphaned file cleanup mechanism
  - [x] Schedule periodic cleanup for unsubmitted files

## Dev Notes
### Relevant Source Tree
- `/apps/web/src/app/api/` - API routes directory
- `/apps/web/public/` - Public assets directory
- `/apps/web/src/middleware.ts` - Middleware for request handling
- `supabase/` - Supabase configuration

### Technical Implementation Details
- Use Next.js 14 App Router API route handlers
- Leverage built-in FormData support in Next.js
- Consider using formidable or multer for advanced multipart handling
- Supabase Storage SDK for cloud storage integration
- Implement both local and cloud storage options for flexibility

### File Naming Convention
- Format: `{timestamp}_{userId}_{originalFileName}`
- Example: `1704067200000_user123_passport.jpg`

### Storage Strategy
- Primary: Supabase Storage (production)
- Fallback: Local file system (development)
- Environment variable to toggle storage mode

### Security Considerations
- Validate MIME types, not just extensions
- Implement virus scanning if possible
- Sanitize file names to prevent path traversal
- Set appropriate CORS headers

## Testing
### Testing Standards
- Test file location: `/apps/web/tests/api/upload/`
- Use Vitest for unit tests
- Mock Supabase Storage client for testing
- Test file validation with various file types and sizes
- Test error scenarios and edge cases
- Verify Portuguese error messages
- Test cleanup mechanism with mock timers

### Test Coverage Requirements
- File type validation (positive and negative cases)
- File size validation boundaries
- Upload success and failure scenarios
- Storage abstraction with both local and Supabase
- Cleanup mechanism functionality
- Error message localization

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Initial story creation from Epic 3 | Sarah (PO) |
| 2025-01-13 | 1.1 | Story implementation completed | James (Dev) |
| 2025-01-13 | 1.2 | QA review completed with security enhancements | Quinn (QA) |

## Dev Agent Record
### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
N/A - No debug logs generated

### Completion Notes List
- Implemented unified /api/upload endpoint supporting both passport and flight documents
- Created FileUploadService with progress tracking capability using XMLHttpRequest
- Implemented file validation for types (jpg, png, pdf, doc, docx) and size (10MB max)
- Added support for both Supabase Storage and local file system storage
- Created FileCleanupService for orphaned file management
- Added cleanup API endpoint at /api/upload/cleanup
- All error messages in Portuguese as required
- Comprehensive test coverage for all components

### File List
- Created: /apps/web/src/app/api/upload/route.ts
- Created: /apps/web/src/app/api/upload/cleanup/route.ts
- Created: /apps/web/src/services/file-upload-service.ts
- Created: /apps/web/src/lib/file-cleanup.ts
- Created: /apps/web/src/lib/file-validation.ts (QA addition)
- Created: /apps/web/src/lib/upload-config.ts (QA addition)
- Created: /apps/web/tests/api/upload/upload.test.ts
- Created: /apps/web/tests/unit/services/file-upload-service.test.ts
- Created: /apps/web/tests/unit/lib/file-cleanup.test.ts
- Modified: /apps/web/src/app/api/upload/route.ts (QA improvements)

## QA Results

### Review Date: 2025-01-13

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

The implementation demonstrates good understanding of file upload requirements with comprehensive validation and error handling. The developer successfully implemented all acceptance criteria with proper separation of concerns. However, several security and architectural improvements were needed to meet production standards.

### Refactoring Performed

- **File**: `/apps/web/src/app/api/upload/route.ts`
  - **Change**: Switched from client Supabase to server Supabase client
  - **Why**: API routes must use server-side Supabase client per coding standards
  - **How**: Changed import and made createClient async to use proper server context

- **File**: `/apps/web/src/app/api/upload/route.ts`
  - **Change**: Enhanced file path validation in DELETE endpoint
  - **Why**: Previous check using `includes()` was vulnerable to path traversal
  - **How**: Changed to `startsWith(user.id + '/')` for strict path validation

- **File**: `/apps/web/src/lib/file-validation.ts` (new)
  - **Change**: Created comprehensive file validation utilities
  - **Why**: Added security layers with MIME type verification and file signature checking
  - **How**: Implemented magic number validation to prevent file type spoofing

- **File**: `/apps/web/src/lib/upload-config.ts` (new)
  - **Change**: Centralized upload configuration management
  - **Why**: Better configuration management and environment validation
  - **How**: Created config helpers with validation functions

- **File**: `/apps/web/src/app/api/upload/route.ts`
  - **Change**: Integrated enhanced validation and secure filename generation
  - **Why**: Improved security against malicious file uploads
  - **How**: Used new validation utilities with file signature verification

### Compliance Check

- Coding Standards: ✓ Fixed after refactoring (proper Supabase client usage)
- Project Structure: ✓ Files properly organized in appropriate directories
- Testing Strategy: ✓ Comprehensive test coverage provided
- All ACs Met: ✓ All 8 acceptance criteria fully implemented

### Improvements Checklist

- [x] Fixed Supabase client usage to follow server-side pattern
- [x] Enhanced security with file signature validation
- [x] Improved path traversal protection in DELETE endpoint
- [x] Created configuration management utilities
- [x] Added comprehensive file validation library
- [ ] Consider implementing virus scanning integration (noted as future enhancement)
- [ ] Add rate limiting for upload endpoints
- [ ] Implement upload quota management per user

### Security Review

**Issues Found and Addressed:**
- Path traversal vulnerability in file deletion - FIXED
- Missing file signature validation - FIXED
- Unsafe filename handling - FIXED with secure filename generator

**Remaining Considerations:**
- Virus scanning not implemented (acceptable for MVP, document for future)
- Rate limiting should be added before production deployment

### Performance Considerations

- File validation is efficient with early returns
- Progress tracking implementation using XMLHttpRequest is appropriate
- Cleanup service designed for background operation
- Consider implementing chunked uploads for very large files in future

### Final Status

✓ **Approved - Ready for Done**

Excellent implementation of file upload infrastructure with all acceptance criteria met. Security improvements have been applied, and the code now meets production standards. The implementation provides a solid foundation for file handling with good separation of concerns and comprehensive error handling.