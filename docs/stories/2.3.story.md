# Story 2.3: Travel Details and Basic Pages (Pages 2-4)

## Status
Done

## Story
**As a** user,
**I want** to specify my travel details and preferences,
**So that** appropriate arrangements can be made.

## Acceptance Criteria
1. Page 2 - Origem/Destino fields with city autocomplete suggestions
2. Page 2 - Data ida/volta with date pickers preventing past dates
3. Page 2 - Tipo de Transporte radio options (Aéreo, Rodoviário, Ambos, Carro Próprio)
4. Page 3 - Tipo de Despesa checkboxes for expense categories
5. Page 4 - Preferências including baggage and transport allowance options
6. Page 4 - Estimated daily allowances number input
7. Conditional navigation logic based on selections
8. All form data synchronized with Zustand store

## Tasks / Subtasks

### Page 2 - Travel Details Implementation

- [x] Create travel details page component (AC: 1, 2, 3)
  - [x] Create apps/web/src/components/form/pages/travel-details.tsx
  - [x] Import shadcn/ui components (Input, Label, RadioGroup, DatePicker)
  - [x] Set up react-hook-form with Zod validation
  - [x] Define responsive layout with TailwindCSS

- [x] Implement origin/destination fields (AC: 1)
  - [x] Create Origem (Origin) input field with Label "Cidade de Origem *"
  - [x] Create Destino (Destination) input field with Label "Cidade de Destino *"
  - [x] Implement city autocomplete using Brazilian city list
  - [x] Create apps/web/src/data/brazilian-cities.json with city data
  - [x] Add search/filter logic for autocomplete suggestions
  - [x] Show dropdown with matching cities as user types

- [x] Implement date picker fields (AC: 2)
  - [x] Add "Data de Ida" (Departure Date) date picker
  - [x] Add "Data de Volta" (Return Date) date picker
  - [x] Validate departure date is not in the past
  - [x] Validate return date is after departure date
  - [x] Format dates in Brazilian format (DD/MM/YYYY)
  - [x] Add calendar icon to date inputs

- [x] Implement transport type selection (AC: 3)
  - [x] Create "Tipo de Transporte" RadioGroup
  - [x] Add options: Aéreo, Rodoviário, Ambos, Carro Próprio
  - [x] Set default selection to "Aéreo"
  - [x] Store selection for conditional logic in later pages

- [x] Create validation schema for Page 2
  - [x] Create apps/web/src/schemas/travel-details.schema.ts
  - [x] Validate required fields (origin, destination, dates)
  - [x] Add date comparison validation
  - [x] Include Portuguese error messages

### Page 3 - Expense Type Implementation

- [x] Create expense type page component (AC: 4)
  - [x] Create apps/web/src/components/form/pages/expense-types.tsx
  - [x] Import Checkbox component from shadcn/ui
  - [x] Set up form state management

- [x] Implement expense checkboxes (AC: 4)
  - [x] Add "Tipo de Despesa" section header
  - [x] Create checkbox options:
    - [x] "Hospedagem" (Accommodation)
    - [x] "Alimentação" (Meals)
    - [x] "Transporte Local" (Local Transport)
    - [x] "Inscrição em Evento" (Event Registration)
    - [x] "Outras Despesas" (Other Expenses)
  - [x] Allow multiple selections
  - [x] Require at least one selection

- [x] Add conditional field for other expenses
  - [x] Show text input when "Outras Despesas" is checked
  - [x] Add placeholder "Especifique outras despesas"
  - [x] Validate required if checkbox is selected

- [x] Create validation schema for Page 3
  - [x] Create apps/web/src/schemas/expense-type.schema.ts
  - [x] Validate at least one checkbox selected
  - [x] Validate other expenses description if applicable

### Page 4 - Preferences Implementation

- [x] Create preferences page component (AC: 5, 6)
  - [x] Create apps/web/src/components/form/pages/preferences.tsx
  - [x] Import Switch/Checkbox and Input components
  - [x] Set up form layout

- [x] Implement baggage allowance preference (AC: 5)
  - [x] Add "Necessita de franquia de bagagem?" switch/checkbox
  - [x] Add helper text explaining baggage allowance
  - [x] Default to checked/true

- [x] Implement transport allowance preference (AC: 5)
  - [x] Add "Necessita de auxílio transporte?" switch/checkbox
  - [x] Add helper text about local transport assistance
  - [x] Default to unchecked/false

- [x] Implement daily allowance estimation (AC: 6)
  - [x] Add "Estimativa de diárias" number input
  - [x] Set minimum value to 1
  - [x] Add helper text: "Número estimado de diárias necessárias"
  - [x] Calculate based on travel dates if available
  - [x] Allow manual override

- [x] Create validation schema for Page 4
  - [x] Create apps/web/src/schemas/preferences.schema.ts
  - [x] Validate daily allowance is positive number
  - [x] Set reasonable maximum (e.g., 365 days)

### Integration Tasks

- [x] Implement conditional navigation logic (AC: 7)
  - [x] Update form store to track transport type selection
  - [x] Determine if destination is international (for Page 5 condition)
  - [x] Store expense type selections for later validation
  - [x] Update visitedPages array correctly

- [x] Integrate all pages with Zustand store (AC: 8)
  - [x] Update store interface with new page data structures
  - [x] Save Page 2 data: origin, destination, dates, transport type
  - [x] Save Page 3 data: expense types array, other expenses text
  - [x] Save Page 4 data: baggage, transport allowance, daily estimate
  - [x] Load existing data when navigating back

- [x] Connect pages to navigation framework
  - [x] Import navigation props from parent component
  - [x] Implement onNext with validation
  - [x] Implement onPrevious to go back
  - [x] Update progress indicator for each page

- [x] Write unit tests for all three pages
  - [x] Create apps/web/tests/unit/components/pages/travel-details.test.tsx
  - [x] Create apps/web/tests/unit/components/pages/expense-types.test.tsx
  - [x] Create apps/web/tests/unit/components/pages/preferences.test.tsx
  - [x] Test validation rules
  - [x] Test conditional logic
  - [x] Test store integration

## Dev Notes

### Previous Story Context
- Story 2.1: Established navigation framework with form-layout.tsx, progress-bar.tsx, and form-store.ts
- Story 2.2: Implemented first form page (passenger-data.tsx) with validation patterns
- Form store structure and navigation patterns are already in place
- Progress indicator shows these as steps 2-4: "Detalhes da Viagem", "Tipo de Despesa", "Preferências"

### Component Structure Pattern
Each page component follows the same interface pattern:
```typescript
interface PageProps {
  onNext: () => void;
  onPrevious: () => void;
}
```
Components integrate with the form layout wrapper from Story 2.1.
[Source: Stories 2.1 and 2.2 patterns]

### Data Model Mapping
From TravelRequest interface, these pages map to:
```typescript
// Page 2 - Travel Details
origin: string;
destination: string;
departureDate: Date;
returnDate: Date;
transportType: 'air' | 'road' | 'both' | 'own_car';

// Page 3 - Expense Types
expenseTypes: string[];

// Page 4 - Preferences
baggageAllowance: boolean;
transportAllowance: boolean;
estimatedDailyAllowance: number;
```
[Source: architecture/data-models.md#travelrequest]

### City Autocomplete Implementation
For the city autocomplete feature:
1. Create a static JSON file with Brazilian cities
2. Implement client-side filtering/search
3. Use Combobox pattern from shadcn/ui or create custom dropdown
4. Consider using react-select or downshift for advanced autocomplete

Brazilian cities data structure:
```json
[
  { "value": "sao-paulo-sp", "label": "São Paulo - SP" },
  { "value": "rio-de-janeiro-rj", "label": "Rio de Janeiro - RJ" },
  // ... more cities
]
```

### Date Validation Logic
Date pickers should:
- Use Brazilian date format (DD/MM/YYYY)
- Prevent selection of past dates for departure
- Ensure return date is after departure date
- Consider using date-fns for date manipulation
- Use shadcn/ui Calendar component or react-datepicker

### Conditional Navigation Rules
Based on Epic 2 requirements:
- Page 5 (International) shows if destination suggests international travel
- This can be determined by checking if destination contains country indicators
- Store this flag in form state for navigation logic
[Source: Epic 2 Story 2.4 - Conditional Pages]

### Expense Type Categories
Standard expense categories for Brazilian business travel:
- Hospedagem (Accommodation)
- Alimentação (Meals) 
- Transporte Local (Local Transport)
- Inscrição em Evento (Event Registration)
- Outras Despesas (Other Expenses)

### Validation Messages (Portuguese)
- Required field: "Campo obrigatório"
- Invalid date: "Data inválida"
- Past date: "A data não pode ser no passado"
- Date order: "A data de volta deve ser após a data de ida"
- No selection: "Selecione pelo menos uma opção"
- Invalid number: "Número inválido"
- Positive number: "O valor deve ser maior que zero"

### UI Components
From shadcn/ui to use:
- Input: Text fields
- Label: Field labels
- RadioGroup, RadioGroupItem: Transport type selection
- Checkbox: Expense type selections
- Calendar/DatePicker: Date selection
- Switch or Checkbox: Boolean preferences
- Select or Combobox: City autocomplete

### Form State Updates
Update Zustand store with nested structure:
```typescript
updateFormData({
  travelDetails: {
    origin,
    destination,
    departureDate,
    returnDate,
    transportType
  },
  expenseTypes: {
    types: selectedTypes,
    otherDescription
  },
  preferences: {
    baggageAllowance,
    transportAllowance,
    estimatedDailyAllowance
  }
})
```

### Testing
- Test files in `apps/web/tests/unit/components/pages/`
- Use Vitest with @testing-library/react
- Mock date functions for consistent testing
- Test city autocomplete filtering
- Test date validation rules
- Test checkbox state management
[Source: architecture/testing-strategy.md]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-12 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
No major debugging issues encountered during implementation

### Completion Notes List
- Successfully implemented all three pages (Pages 2-4) with complete form validation
- Created comprehensive city autocomplete functionality with Brazilian cities data
- Implemented proper date validation with Brazilian format support
- Added conditional logic for international travel detection
- All pages follow established patterns from passenger-data page
- Added comprehensive unit tests for all three pages
- Pages properly integrate with Zustand store and navigation framework

### File List
**New Files Created:**
- apps/web/src/schemas/travel-details.schema.ts - Validation schema for Page 2
- apps/web/src/schemas/expense-type.schema.ts - Validation schema for Page 3  
- apps/web/src/schemas/preferences.schema.ts - Validation schema for Page 4
- apps/web/src/data/brazilian-cities.json - Brazilian cities data for autocomplete
- apps/web/src/hooks/use-city-autocomplete.ts - Custom hook for city autocomplete functionality (QA refactor)
- apps/web/tests/unit/components/pages/travel-details.test.tsx - Unit tests for travel details page
- apps/web/tests/unit/components/pages/expense-types.test.tsx - Unit tests for expense types page
- apps/web/tests/unit/components/pages/preferences.test.tsx - Unit tests for preferences page

**Modified Files:**
- apps/web/src/components/form/pages/travel-details.tsx - Complete rewrite with validation and autocomplete, refactored to use custom hook
- apps/web/src/components/form/pages/expense-types.tsx - Complete rewrite with proper validation
- apps/web/src/components/form/pages/preferences.tsx - Complete rewrite with daily allowance calculation
- apps/web/src/components/form/pages/index.ts - Added ref type exports
- apps/web/src/stores/form-store.ts - Added otherExpenseDescription field
- apps/web/src/components/form/form-layout.tsx - Fixed import type for ReactNode
- apps/web/src/app/form/multi-step-page.tsx - Fixed ref callback for TypeScript compliance (QA fix)

## QA Results

### Review Date: 2025-08-13

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

**Excellent Implementation Quality** - The developer has successfully implemented all three form pages (Pages 2-4) with comprehensive validation, proper TypeScript usage, and modern React patterns. The implementation demonstrates strong understanding of:

- React Hook Form with Zod validation patterns
- Custom hooks for reusable logic
- Proper TypeScript interfaces and type safety
- Zustand state management integration
- Comprehensive test coverage with meaningful assertions

The code follows established patterns from previous stories and maintains consistency across the application.

### Refactoring Performed

- **File**: `apps/web/src/hooks/use-city-autocomplete.ts`
  - **Change**: Created custom hook for city autocomplete functionality
  - **Why**: Extracted complex autocomplete logic into reusable, testable hook
  - **How**: Improves code organization, performance with memoization, and provides better international travel detection

- **File**: `apps/web/src/components/form/pages/travel-details.tsx`
  - **Change**: Refactored to use custom autocomplete hook and improved international detection
  - **Why**: Reduces component complexity and improves maintainability
  - **How**: Separates concerns, improves performance with memoized city filtering, and adds better accessibility

- **File**: `apps/web/src/schemas/preferences.schema.ts`
  - **Change**: Fixed TypeScript type issues with optional boolean fields
  - **Why**: Resolved compilation errors and improved type safety
  - **How**: Removed unnecessary .optional() calls that conflicted with React Hook Form types

- **File**: `apps/web/src/app/form/multi-step-page.tsx`
  - **Change**: Fixed ref callback to handle null values properly
  - **Why**: Eliminated TypeScript errors related to ref assignment
  - **How**: Added null check in ref callback to satisfy TypeScript strict mode

- **File**: `apps/web/tests/unit/components/pages/travel-details.test.tsx`
  - **Change**: Updated test assertion to handle multiple validation messages
  - **Why**: Test was failing due to multiple "Campo obrigatório" messages appearing
  - **How**: Changed to expect exact count of validation messages for better test reliability

### Compliance Check

- **Coding Standards**: ✓ **Excellent** - Follows all established patterns, uses absolute imports, proper naming conventions
- **Project Structure**: ✓ **Perfect** - All files in correct locations, follows established directory structure
- **Testing Strategy**: ✓ **Comprehensive** - Unit tests cover all major functionality and edge cases
- **All ACs Met**: ✓ **Complete** - All 8 acceptance criteria fully implemented and verified

### Improvements Checklist

- [x] Extracted city autocomplete logic to reusable custom hook (use-city-autocomplete.ts)
- [x] Enhanced international travel detection with comprehensive keyword matching
- [x] Fixed TypeScript compilation errors in preferences schema and multi-step page
- [x] Improved performance with memoized city filtering and React.useMemo
- [x] Updated test assertions to handle multiple validation messages correctly
- [x] Added comprehensive JSDoc comments and proper error handling

### Security Review

**No Security Concerns** - All user inputs are properly validated with Zod schemas before processing. No direct DOM manipulation or unsafe operations detected. Form data is handled through controlled components with proper sanitization.

### Performance Considerations

**Well Optimized** - Implementation includes several performance optimizations:
- Memoized city filtering to prevent unnecessary recalculations
- Limited autocomplete results (10 items) for better UX
- Proper cleanup of event listeners to prevent memory leaks  
- Efficient re-rendering with React Hook Form's optimized field watching

### Final Status

**✓ Approved - Ready for Done**

**Exceptional work!** This implementation demonstrates senior-level React development with proper architecture, comprehensive testing, and attention to detail. The code is production-ready and provides an excellent foundation for the remaining form pages.