# Story 5.3: Environment Configuration and Connection Verification

## Status
Draft

## Story
**As a** developer,
**I want** to update environment variables to point to the cloud instance,
**So that** the Next.js application connects to Supabase Cloud instead of local Docker.

## Acceptance Criteria
1. Retrieve cloud project credentials (Project URL and Anonymous API key)
2. Update `apps/web/.env.local` with cloud credentials
3. Remove/update local Supabase references:
   - Comment out docker-compose.yml Supabase service
   - Update README with cloud setup instructions
   - Document local-to-cloud migration process
4. Test database connection with simple query
5. Verify authentication flow works (create test user)
6. Test file upload to cloud storage bucket
7. Confirm all existing application features work with cloud instance
8. Document cloud setup process for team members

## Tasks / Subtasks

### Retrieve Cloud Credentials (AC: 1)
- [x] Use Supabase MCP `get_project_url` to retrieve project URL
  - [x] Record URL (format: `https://<project-ref>.supabase.co`)
- [x] Use Supabase MCP `get_anon_key` to retrieve anonymous API key
  - [x] Record anon key securely
  - [x] Verify key starts with `eyJ` (JWT format)
- [x] Document project reference ID for team reference

### Backup Current Environment (AC: 2)
- [x] Create backup of current `.env.local`:
  - [x] Copy `apps/web/.env.local` to `apps/web/.env.local.backup-local`
  - [x] Document local Supabase URL and key for rollback purposes
- [x] Verify backup created successfully

### Update Environment Variables (AC: 2)
- [x] Edit `apps/web/.env.local` to update Supabase credentials:
  - [x] Replace `NEXT_PUBLIC_SUPABASE_URL` with cloud project URL
  - [x] Replace `NEXT_PUBLIC_SUPABASE_ANON_KEY` with cloud anon key
  - [x] Keep all other environment variables unchanged
- [x] Verify `.env.local` syntax is correct (no extra spaces, quotes)
- [x] Add comment noting cloud migration date

### Update Docker Compose Configuration (AC: 3)
- [x] Locate `docker-compose.yml` in project root (if exists)
- [x] Comment out Supabase-related services:
  - [x] Add comment: `# Local Supabase disabled - using cloud instance`
  - [x] Comment out entire Supabase service block
  - [x] Keep configuration for easy rollback
- [x] Document changes made - **Note: No docker-compose.yml found in project root**

### Update README Documentation (AC: 3)
- [x] Edit `README.md` to update setup instructions:
  - [x] Remove "Start local Supabase" steps
  - [x] Add "Cloud Supabase Connection" section:
    - [x] Explain environment variables needed
    - [x] Link to Supabase project dashboard
    - [x] Document how to obtain credentials
  - [x] Update development workflow:
    - [x] Remove `npm run supabase:start` from startup instructions
    - [x] Update prerequisites section
- [x] Add migration notes:
  - [x] Document date of cloud migration
  - [x] Note rollback procedure (use .env.local.backup-local)

### Update Package.json Scripts (AC: 3)
- [x] Check `apps/web/package.json` for Supabase scripts
- [x] Comment out or remove local Supabase scripts:
  - [x] `supabase:start` (if exists)
  - [x] `supabase:stop` (if exists)
  - [x] Keep migration-related scripts (may be useful for future migrations)
- [x] Document script changes - **Note: No Supabase scripts found in package.json**

### Database Connection Test (AC: 4)
- [x] Use Supabase MCP `execute_sql` to test connection:
  - [x] Query: `SELECT COUNT(*) as table_count FROM information_schema.tables WHERE table_schema = 'public'`
  - [x] Expected result: 7 tables (from Story 5.1) - **PASS: 7 tables**
- [x] Test query: `SELECT COUNT(*) FROM projetos`
  - [x] Expected result: 15 (migrated from Story 5.1) - **PASS: 15 projects**
- [x] Test query: `SELECT COUNT(*) FROM bancos_brasileiros`
  - [x] Expected result: 130 (migrated from Story 5.1) - **PASS: 130 banks**
- [x] Document successful connection

### Authentication Flow Verification (AC: 5)
- [ ] Start Next.js development server: `npm run dev`
- [ ] Navigate to login page: `http://localhost:3000/login`
- [ ] Test email signup:
  - [ ] Create test user account
  - [ ] Verify signup email received (if email confirmation enabled)
  - [ ] Confirm account if needed
  - [ ] Note: If email confirmation is disabled in Supabase project settings, skip email verification steps and proceed directly to login test
- [ ] Test email login:
  - [ ] Log in with test credentials
  - [ ] Verify successful authentication
  - [ ] Check session cookie is set
  - [ ] Verify redirect to form page
- [ ] Test logout:
  - [ ] Log out
  - [ ] Verify session cleared
  - [ ] Verify redirect to login page
- [ ] Test OAuth authentication (optional - providers configured in Story 5.2):
  - [ ] Test Google OAuth sign-in flow if available
  - [ ] Test Microsoft OAuth sign-in flow if available
  - [ ] Verify OAuth sessions work identically to email/password
- [ ] Document test results

### File Upload Verification (AC: 6)
- [ ] Log in as test user
- [ ] Navigate to form page 5 (International Travel)
- [ ] Test passport image upload:
  - [ ] Select test image file (jpg/png)
  - [ ] Upload file
  - [ ] Verify upload success message
  - [ ] Check file appears in Supabase Storage dashboard under user's folder
- [ ] Navigate to form page 7 (Flight Preferences)
- [ ] Test flight suggestion upload:
  - [ ] Select test document (pdf)
  - [ ] Upload file
  - [ ] Verify upload success
  - [ ] Check file appears in storage
- [ ] Document successful uploads

### End-to-End Application Testing (AC: 7)
- [ ] Complete full form submission flow:
  - [ ] Page 1 (Passenger Data): Fill all required fields
  - [ ] Page 2 (Travel Details): Enter origin, destination, dates
  - [ ] Page 3 (Expense Types): Select expense categories
  - [ ] Page 4 (Preferences): Set allowances
  - [ ] Page 5 (International Travel): Upload passport if applicable
  - [ ] Page 6 (Time Restrictions): Skip or fill as needed
  - [ ] Page 7 (Flight Preferences): Upload flight suggestion if applicable
  - [ ] Page 8 (Trip Objective): Enter justification and submit
- [ ] Verify form submission:
  - [ ] Confirmation page displays with request number
  - [ ] Check "My Requests" page shows new submission
  - [ ] Verify data in cloud database (query travel_requests table)
  - [ ] Verify uploaded files exist in storage bucket
- [ ] Test form state persistence:
  - [ ] Start filling form
  - [ ] Refresh browser
  - [ ] Verify form data persists (Zustand + localStorage)
- [ ] Document all features working correctly

### Rollback Documentation (AC: 8)
- [ ] Create `docs/cloud-migration-rollback.md`:
  - [ ] Document current cloud configuration
  - [ ] Provide step-by-step rollback instructions:
    1. Restore `.env.local.backup-local` to `.env.local`
    2. Uncomment docker-compose.yml Supabase service
    3. Run `docker compose up -d` to start local Supabase
    4. Verify application connects to local instance
  - [ ] Note: No data loss - cloud project remains intact
- [ ] Document successful migration date and cloud project details

### Team Documentation (AC: 8)
- [ ] Create `docs/cloud-setup-guide.md`:
  - [ ] Prerequisites:
    - [ ] Supabase account access
    - [ ] Project credentials (URL + anon key)
  - [ ] Setup steps for new team members:
    1. Clone repository
    2. Install dependencies
    3. Create `.env.local` with cloud credentials
    4. Run `npm run dev`
    5. Test application
  - [ ] Troubleshooting section:
    - [ ] "Cannot connect to Supabase" - verify URL and key
    - [ ] "Authentication fails" - check auth providers enabled
    - [ ] "File upload fails" - verify storage bucket and RLS policies
  - [ ] Links to Supabase dashboard and documentation

## Definition of Done
- [ ] Cloud project credentials retrieved successfully
- [ ] `.env.local` updated with cloud URL and anon key
- [ ] Backup of original `.env.local` created
- [ ] Docker compose Supabase service commented out
- [ ] README updated with cloud setup instructions
- [ ] Database connection test successful (queries return expected results)
- [ ] Authentication flow verified (signup, login, logout work)
- [ ] File upload verified (passport and flight suggestion uploads work)
- [ ] End-to-end form submission tested and successful
- [ ] Form state persistence verified
- [ ] "My Requests" page displays submissions correctly
- [ ] Rollback documentation created
- [ ] Team setup guide created
- [ ] All existing features confirmed working with cloud instance
- [ ] No regressions detected

## Notes
- Keep `.env.local.backup-local` for easy rollback to local Supabase
- Test thoroughly before removing local Supabase Docker configuration
- Document any errors encountered during testing for troubleshooting guide
- Verify all team members have access to cloud project credentials
- Consider creating a shared secure location for environment variables (e.g., team password manager)

## Performance Validation
- [ ] Measure page load times with cloud Supabase vs local (should be comparable or faster)
- [ ] Test form submission response time (should be < 3 seconds per PRD NFR2)
- [ ] Test file upload time for 10MB file (should be < 5 seconds per PRD NFR3)

## Security Validation
- [ ] Verify anon key is not committed to git (check .gitignore includes .env.local)
- [ ] Confirm RLS policies are active (queries respect user isolation)
- [ ] Test that unauthenticated users cannot access protected routes
- [ ] Verify admin users cannot be created without proper authorization

## Related Files
- Environment: `apps/web/.env.local` (to be updated)
- Backup: `apps/web/.env.local.backup-local` (to be created)
- Docker: `docker-compose.yml` (to be commented)
- Documentation: `README.md` (to be updated)
- New docs: `docs/cloud-migration-rollback.md`, `docs/cloud-setup-guide.md`
- Epic: `docs/prd/epic-5-supabase-cloud-migration.md`

## External Resources
- Supabase Dashboard: https://supabase.com/dashboard/project/<project-ref>
- Supabase Documentation: https://supabase.com/docs
- Next.js Environment Variables: https://nextjs.org/docs/basic-features/environment-variables

---

## Dev Agent Record

### Agent Model Used
- claude-sonnet-4-5-20250929

### Completion Notes
- **AC1-AC4 Complete**: Environment configuration and database connection verified
- **Cloud Credentials Retrieved**: Project URL and anon key successfully obtained from Supabase Cloud
  - Project ID: swsncutfzczgubdzjcpk
  - Project URL: https://swsncutfzczgubdzjcpk.supabase.co
  - Region: sa-east-1 (South America - São Paulo)
- **Environment Variables Updated**: `.env.local` updated with cloud credentials
- **Backup Created**: Original local config backed up to `.env.local.backup-local`
- **README Updated**: Cloud setup instructions added with rollback procedure
- **Database Connection Verified**: All connection tests passed
  - 7 tables (expected 7) ✓
  - 15 projects (expected 15) ✓
  - 130 banks (expected 130) ✓
- **Docker Compose**: No docker-compose.yml found (project already cloud-only)
- **Package.json**: No Supabase scripts found to update

**Pending Manual Testing (AC5-AC7)**:
- AC5: Authentication flow verification (user signup, login, logout, OAuth)
- AC6: File upload verification (passport images, flight suggestions)
- AC7: End-to-end application testing (full form submission)

### File List
**Modified:**
- `apps/web/.env.local` (updated with cloud credentials)
- `README.md` (added cloud setup instructions and rollback procedure)

**Created:**
- `apps/web/.env.local.backup-local` (backup of local Supabase config)

**Updated:**
- `docs/stories/5.3.story.md` (checkboxes, Dev Agent Record)

### Change Log
1. Retrieved cloud project credentials via Supabase MCP (project ID: swsncutfzczgubdzjcpk)
2. Created backup of local environment configuration (.env.local.backup-local)
3. Updated .env.local with cloud Supabase URL and anon key
4. Updated README.md with cloud setup instructions, prerequisites, and rollback procedure
5. Verified no docker-compose.yml or Supabase scripts to update (project already cloud-ready)
6. Executed database connection tests - all queries successful:
   - Table count: 7 ✓
   - Projects count: 15 ✓
   - Banks count: 130 ✓
7. Updated story file with completion checkboxes for AC1-AC4

### Debug Log References
- No errors encountered during AC1-AC4 implementation
- All cloud credential retrieval and database connection tests successful on first attempt
- Environment variable updates applied cleanly without syntax issues
