# Story 5.1: Cloud Database Schema Setup and Data Migration

## Status
Ready for Review

## Prerequisites
- Supabase MCP Server configured and available in Claude Code environment
- Authentication to Supabase Cloud established (MCP handles credentials)
- Access to existing trip-form-app project in sa-east-1 region (South America - São Paulo)
- Migration files present in `supabase/migrations/` directory

## Story
**As a** developer,
**I want** to apply all database migrations to the Supabase Cloud project,
**So that** the cloud database matches the local schema with all reference data loaded.

## Acceptance Criteria
1. Identify existing Supabase cloud project (trip-form-app) in sa-east-1 region
2. Apply migrations in chronological order:
   - `20250811_initial_schema.sql` (base tables + RLS)
   - `20250812_optimize_rls_policies.sql` (RLS optimization)
   - `20250813_final_rls_optimization.sql` (final RLS)
   - `20250115_create_projetos_table.sql` (projects table)
   - `populate_projetos.sql` (53 projects data)
   - `20251017111942_create_bancos_brasileiros_table.sql` (banks table)
   - `20251017_220000_add_structured_bank_fields.sql` (structured bank fields)
   - `add_missing_travel_request_columns.sql` (additional columns)
3. Verify all 8 expected tables exist: profiles, travel_requests, status_history, file_attachments, form_drafts, projetos, bancos_brasileiros, bancos_brasileiros (if separate)
4. Confirm RLS policies are enabled on all relevant tables
5. Verify 53 projects loaded in projetos table
6. Verify 190+ banks loaded in bancos_brasileiros table
7. Run security and performance advisors to check for issues

## Tasks / Subtasks

### Project Identification and Verification (AC: 1)
- [x] Use Supabase MCP `list_projects` to find trip-form-app project
- [x] Use `get_project` to verify:
  - [x] Project is in sa-east-1 region (South America - São Paulo)
  - [x] Project status is ACTIVE_HEALTHY
  - [x] Note project_id for subsequent operations (swsncutfzczgubdzjcpk)
- [x] Use `list_tables` to check current database state (empty - ready for migrations)

### Base Schema Migration (AC: 2 - Initial Schema)
- [x] Read `supabase/migrations/20250811_initial_schema.sql`
- [x] Use `apply_migration` with name "initial_schema" to create:
  - [x] profiles table (linked to auth.users)
  - [x] travel_requests table (main form data)
  - [x] status_history table (audit trail)
  - [x] file_attachments table (uploaded files metadata)
  - [x] form_drafts table (save progress)
- [x] Verify helper functions created:
  - [x] generate_request_number() function
  - [x] set_request_number() trigger
  - [x] update_updated_at() function and triggers
- [x] Verify indexes created on travel_requests (user_id, status, created_at, request_number)

### RLS Policies Migration (AC: 2 - Optimization)
- [x] Read `supabase/migrations/20250812_optimize_rls_policies.sql`
- [x] Apply migration "optimize_rls_policies"
- [x] Read `supabase/migrations/20250813_final_rls_optimization.sql`
- [x] Apply migration "final_rls_optimization"
- [x] Verify RLS is enabled on all tables (optimized policies applied)

### Projects Reference Table (AC: 2 - Projects)
- [x] Read `supabase/migrations/20250115_create_projetos_table.sql`
- [x] Apply migration "create_projetos_table"
- [x] Read `supabase/migrations/populate_projetos.sql`
- [x] Execute SQL to populate CEIA projects (15 projects available in migration file)
- [x] Verify rows in projetos table (15 projects loaded - migration file contains 15, not 53)

### Brazilian Banks Reference Table (AC: 2 - Banks)
- [x] Read `supabase/migrations/20251017111942_create_bancos_brasileiros_table.sql`
- [x] Apply migration "create_bancos_brasileiros_table"
- [x] Verify table created with columns: codigo_compensacao, nome_instituicao
- [x] Verify data populated (130 Brazilian banks loaded)

### Structured Bank Fields Enhancement (AC: 2)
- [x] Read `supabase/migrations/20251017_220000_add_structured_bank_fields.sql`
- [x] Apply migration "add_structured_bank_fields"
- [x] Verify columns added to travel_requests:
  - [x] bank_name TEXT
  - [x] bank_branch TEXT
  - [x] bank_account TEXT
- [x] Verify index created: idx_travel_requests_bank_name

### Missing Columns Migration (AC: 2)
- [x] Read `supabase/migrations/add_missing_travel_request_columns.sql`
- [x] Apply migration "add_missing_travel_request_columns"
- [x] Verify columns added: baggage_allowance, transport_allowance, estimated_daily_allowance

### Schema Verification (AC: 3, 4)
- [x] Use `list_tables` to verify all 7 tables exist:
  - [x] profiles (RLS enabled)
  - [x] travel_requests (RLS enabled)
  - [x] status_history (RLS enabled)
  - [x] file_attachments (RLS enabled)
  - [x] form_drafts (RLS enabled)
  - [x] projetos (RLS enabled)
  - [x] bancos_brasileiros (RLS enabled)
- [x] Verified RLS enabled on all tables via list_tables API response

### Data Verification (AC: 5, 6)
- [x] Execute query: `SELECT COUNT(*) FROM projetos` → 15 projects (migration contains 15, not 53)
- [x] Execute query: `SELECT COUNT(*) FROM bancos_brasileiros` → 130 banks (migration contains 130)
- [x] Execute sample query: `SELECT * FROM projetos LIMIT 5` to verify data quality ✓
- [x] Execute sample query: `SELECT * FROM bancos_brasileiros LIMIT 5` to verify structure ✓

### Security and Performance Check (AC: 7)
- [x] Use `get_advisors` with type="security" to check for vulnerabilities
- [x] Review security advisor results - No CRITICAL issues found ✓ (1 WARN: function search_path)
- [x] Use `get_advisors` with type="performance" to check for optimization opportunities
- [x] Document warnings: 2 WARN (RLS performance), multiple INFO (unused indexes expected for new DB)

### Documentation
- [x] Document migration execution order and results (see Dev Agent Record below)
- [x] Note any migration errors or warnings encountered (no errors - all successful)
- [x] Record final table count and row counts for reference data (7 tables, 15 projects, 130 banks)
- [x] Architecture documentation up to date (cloud database operational)

## Definition of Done
- [x] All 8 migrations applied successfully without errors ✓
- [x] All 7 tables exist in cloud database (AC mentions 8, actual schema has 7) ✓
- [x] RLS policies confirmed active on all tables ✓
- [x] 15 projects verified in projetos table (migration file contains 15, not 53 as stated in AC) ✓
- [x] 130 banks verified in bancos_brasileiros table (migration file contains 130, not 190+ as stated in AC) ✓
- [x] Security advisors show no critical vulnerabilities ✓
- [x] Performance advisors checked and results documented ✓
- [x] Migration execution documented for team reference ✓

## Notes
- Use Supabase MCP Server for all database operations
- Migration files are located in `supabase/migrations/`
- Apply migrations in chronological order to avoid dependency issues
- Test queries can be executed with `execute_sql` tool
- If migration fails, investigate error before proceeding to next migration

## Related Files
- Migration files: `supabase/migrations/*.sql`
- Original schema reference: `docs/architecture.md#database-schema`
- Epic: `docs/prd/epic-5-supabase-cloud-migration.md`

---

## Dev Agent Record

### Agent Model Used
- claude-sonnet-4-5-20250929

### Completion Notes
- **Migration Success**: All 8 migrations applied successfully without errors
- **Database Setup**: Supabase Cloud project (swsncutfzczgubdzjcpk) in sa-east-1 region configured
- **Tables Created**: 7 tables with full schema and RLS policies enabled
- **Reference Data**: 15 CEIA projects and 130 Brazilian banks populated
- **Security**: No CRITICAL vulnerabilities found (1 WARN on function search_path - non-blocking)
- **Performance**: 2 WARN on RLS performance optimization opportunities (future enhancement)
- **Data Discrepancies Documented**: AC expected 53 projects (actual: 15) and 190+ banks (actual: 130) - migration files contain these actual counts

### File List
**Modified:**
- `docs/stories/5.1.story.md` (story checkboxes and Dev Agent Record)

**Executed Migrations (applied to cloud database):**
- `supabase/migrations/20250811_initial_schema.sql`
- `supabase/migrations/20250812_optimize_rls_policies.sql`
- `supabase/migrations/20250813_final_rls_optimization.sql`
- `supabase/migrations/20250115_create_projetos_table.sql`
- `supabase/migrations/populate_projetos.sql`
- `supabase/migrations/20251017111942_create_bancos_brasileiros_table.sql`
- `supabase/migrations/20251017_220000_add_structured_bank_fields.sql`
- `supabase/migrations/add_missing_travel_request_columns.sql`

### Change Log
1. Applied initial_schema migration - created 5 base tables (profiles, travel_requests, status_history, file_attachments, form_drafts)
2. Applied RLS optimization migrations - consolidated and optimized Row Level Security policies
3. Created projetos table and populated with 15 CEIA projects
4. Created bancos_brasileiros table and populated with 130 Brazilian banking institutions
5. Added structured bank fields (bank_name, bank_branch, bank_account) to travel_requests table
6. Added missing allowance columns (baggage_allowance, transport_allowance, estimated_daily_allowance) to travel_requests
7. Verified all tables, RLS policies, and reference data
8. Ran security and performance advisors - no blocking issues found

### Debug Log References
- No errors encountered during migration execution
- All migrations applied successfully on first attempt
- Security advisor warnings documented but non-blocking for initial deployment
